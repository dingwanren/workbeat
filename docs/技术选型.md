# Workbeat - Git仓库分析工具 - 技术选型 Rules 文档

## 1. 核心技术栈强制规则

### 1.1 语言与运行时
```typescript
// 必须遵守
- 语言: TypeScript (strict: true)
- 运行时: Node.js ≥ 18.0.0
- 模块: ES Modules only
- 包管理器: npm (禁止使用 yarn/pnpm)

// 禁止项
- 禁止使用 JavaScript
- 禁止使用 CommonJS
- 禁止使用 experimental 特性
```

### 1.2 依赖包使用规则

#### Commander.js (CLI框架)
```typescript
// 必须这样使用
import { Command } from 'commander';

const program = new Command();
program
  .name('workbeat')
  .description('分析Git仓库工作节奏')
  .version('1.0.0');

// 选项定义规范
program
  .option('-r, --repos <paths...>', '仓库路径列表')
  .option('-s, --since <date>', '起始日期')
  .option('-p, --port <number>', '服务端口', '3000');

// 禁止：直接处理 process.argv
```

#### SimpleGit (Git操作)
```typescript
// 必须这样使用
import simpleGit, { SimpleGit } from 'simple-git';

const git: SimpleGit = simpleGit(repoPath);

// Git日志格式必须统一
const log = await git.log({
  format: {
    hash: '%H',
    authorName: '%aN',
    authorEmail: '%aE',
    date: '%aI',
    message: '%s'
  }
});

// 禁止：使用 child_process 执行 git 命令
// 禁止：使用其他Git库如 nodegit/isomorphic-git
```

#### Date-fns (日期处理)
```typescript
// 必须使用 date-fns，禁止其他日期库
import { 
  parseISO, format, isWeekend, 
  getHours, getDay, differenceInDays 
} from 'date-fns';

// 日期解析必须统一
const commitDate = parseISO(commit.timestamp);
const hour = getHours(commitDate);
const isWeekendCommit = isWeekend(commitDate);

// 禁止：使用 moment.js / day.js
```

#### Lodash (工具函数)
```typescript
// 原则：优先原生，复杂操作用lodash
import { groupBy, sumBy, meanBy, throttle } from 'lodash';

// 允许使用场景：
const commitsByAuthor = groupBy(commits, 'author.email');
const totalLines = sumBy(commits, 'insertions');

// 禁止：简单操作用lodash（如 map/filter）
const authorNames = commits.map(c => c.author.name); // ✅ 正确
const authorNames = _.map(commits, 'author.name');   // ❌ 禁止
```

#### Vue 3 + Vite + ECharts (可视化服务)
```typescript
// Vue 3 + Vite + ECharts
// 用于构建现代化的前端可视化界面
// 禁止：使用 Express + EJS 服务端渲染
// 禁止：使用其他前端框架如 React、Angular
```

#### ECharts (图表库)
```typescript
// 必须通过CDN引入，禁止npm安装
// 在模板中引入：
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>

// 禁止：npm install echarts
// 禁止：使用 Chart.js / D3.js
```

## 2. 开发工具链规则

### 2.1 构建工具
```typescript
// 必须使用 tsup，禁止其他构建工具
// package.json 配置：
{
  "scripts": {
    "build": "tsup src/index.ts --format esm --dts --clean",
    "dev": "tsup src/index.ts --format esm --watch"
  }
}

// 禁止：使用 webpack/rollup/esbuild 直接配置
```

### 2.2 代码质量工具
```json
// 必须配置的开发依赖
{
  "devDependencies": {
    "typescript": "^5.0.0",
    "@types/node": "^20.0.0",
    "@typescript-eslint/eslint-plugin": "^6.0.0",
    "@typescript-eslint/parser": "^6.0.0",
    "eslint": "^8.0.0",
    "prettier": "^3.0.0",
    "husky": "^8.0.0",
    "lint-staged": "^13.0.0"
  }
}
```

### 2.3 类型定义规则
```typescript
// 所有导出必须要有类型定义
export interface CommitData {
  hash: string;
  author: {
    name: string;
    email: string;
  };
  timestamp: Date;
  insertions: number;
  deletions: number;
  filesChanged: number;
}

// 禁止使用 any
// 必须使用严格空值检查
```

## 3. 项目结构强制规则

### 3.1 目录结构
```
workbeat/
├── src/
│   ├── types/          # 类型定义 (*.ts)
│   ├── core/           # 核心逻辑
│   ├── cli/            # 命令行
│   ├── metrics/        # 指标计算
│   └── utils/          # 工具函数
├── bin/               # CLI入口 (必须为 .js)
└── dist/              # 构建输出
```

### 3.2 文件命名规则
```typescript
// 必须遵守的命名规范
- 源文件: kebab-case.ts (git-analyzer.ts)
- 类型文件: kebab-case.ts (commit-types.ts)  
- 模板文件: kebab-case.ejs (dashboard.ejs)
- 入口文件: index.ts (各模块入口)

// 禁止：使用 PascalCase/camelCase 命名文件
```

## 4. 依赖版本锁定规则

### 4.1 必须使用的版本范围
```json
{
  "dependencies": {
    "commander": "^11.0.0",
    "inquirer": "^9.0.0", 
    "simple-git": "^3.0.0",
    "date-fns": "^2.0.0",
    "express": "^4.18.0",
    "ejs": "^3.1.0",
    "lodash": "^4.17.0"
  },
  "devDependencies": {
    "typescript": "^5.0.0",
    "@types/node": "^20.0.0",
    "@types/express": "^4.17.0",
    "@types/ejs": "^3.1.0",
    "@types/lodash": "^4.17.0",
    "@types/inquirer": "^9.0.0",
    "tsup": "^7.0.0"
  }
}
```

## 5. 编码实践禁止项

### 5.1 绝对禁止的模式
```typescript
// ❌ 禁止使用 any
const data: any = getData();

// ❌ 禁止使用 require
const fs = require('fs');

// ❌ 禁止使用 module.exports
module.exports = GitAnalyzer;

// ❌ 禁止使用 var
var name = 'test';

// ❌ 禁止使用 eval/new Function
eval('console.log("bad")');

// ❌ 禁止使用同步文件操作（除CLI入口）
const data = fs.readFileSync('file.json');
```

### 5.2 异步操作规则
```typescript
// ✅ 必须使用 async/await
class GitAnalyzer {
  async getCommits(): Promise<CommitData[]> {
    const log = await this.git.log();
    return this.parseCommits(log);
  }
}

// ❌ 禁止使用 .then() 链式调用
this.git.log().then(log => { ... });
```
