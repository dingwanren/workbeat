<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Git仓库工作节奏分析</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .chart-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        .chart-row {
            display: flex;
            gap: 20px;
        }
        .chart-item {
            flex: 1;
            height: 400px;
        }
        .error-message {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .repo-selector {
            text-align: center;
            margin-bottom: 20px;
        }
        .repo-selector input {
            padding: 10px;
            width: 400px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .repo-selector button {
            padding: 10px 20px;
            background-color: #1976d2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        .repo-selector button:hover {
            background-color: #1565c0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Git仓库工作节奏分析</h1>
            <p>分析Git提交历史，可视化展示团队成员的工作模式和代码贡献</p>
        </div>

        <% if (typeof loading !== 'undefined' && loading) { %>
            <div class="error-message">
                <strong>提示:</strong> <%= typeof message !== 'undefined' ? message : '正在加载数据，请稍候...' %>
            </div>
        <% } %>
        <% if (typeof error !== 'undefined' && error) { %>
            <div class="error-message">
                <strong>错误:</strong> <%= error %>
            </div>
        <% } %>

        <div class="repo-selector">
            <label for="repoPath">仓库路径: </label>
            <input type="text" id="repoPath" value="<%= repoPath %>" placeholder="输入仓库路径">
            <button onclick="refreshData()">刷新数据</button>
        </div>

        <div class="chart-row">
            <div class="chart-container">
                <div id="contributionChart" class="chart-item"></div>
            </div>
        </div>

        <div class="chart-row">
            <div class="chart-container">
                <div id="changesChart" class="chart-item"></div>
            </div>
        </div>

        <div class="chart-row">
            <div class="chart-container">
                <div id="trendChart" class="chart-item"></div>
            </div>
        </div>

        <!-- 指标表格 -->
        <div class="chart-container">
            <h2>详细指标</h2>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #f0f0f0;">
                        <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">作者</th>
                        <th style="border: 1px solid #ddd; padding: 12px; text-align: center;">提交次数</th>
                        <th style="border: 1px solid #ddd; padding: 12px; text-align: center;">插入行数</th>
                        <th style="border: 1px solid #ddd; padding: 12px; text-align: center;">删除行数</th>
                        <th style="border: 1px solid #ddd; padding: 12px; text-align: center;">净变化</th>
                        <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">活跃时间</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (typeof metrics !== 'undefined' && metrics.length > 0) { %>
                        <% metrics.forEach(function(metric) { %>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px;">
                                <%= metric.author.name %> &lt;<%= metric.author.email %>&gt;
                            </td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;"><%= metric.commitCount %></td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center; color: #4caf50;"><%= metric.totalInsertions %></td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center; color: #f44336;"><%= metric.totalDeletions %></td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;"><%= metric.netChanges %></td>
                            <td style="border: 1px solid #ddd; padding: 8px;">
                                <%= new Date(metric.firstCommitDate).toLocaleDateString() %> ~ 
                                <%= new Date(metric.lastCommitDate).toLocaleDateString() %>
                            </td>
                        </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="6" style="border: 1px solid #ddd; padding: 12px; text-align: center;">暂无数据</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // 等待DOM加载完成后再初始化图表
        document.addEventListener('DOMContentLoaded', function() {
            // 确保ECharts已加载
            if (typeof echarts === 'undefined') {
                console.error('ECharts library not loaded');
                return;
            }

            // 初始化图表 - 确保DOM元素存在
            const contributionChartElement = document.getElementById('contributionChart');
            const changesChartElement = document.getElementById('changesChart');
            const trendChartElement = document.getElementById('trendChart');

            if (contributionChartElement && changesChartElement && trendChartElement) {
                const contributionChart = echarts.init(contributionChartElement);
                const changesChart = echarts.init(changesChartElement);
                const trendChart = echarts.init(trendChartElement);

                // 作者贡献对比图
                const contributionOption = {
                    title: {
                        text: '作者贡献对比',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        }
                    },
                    legend: {
                        data: ['提交次数', '插入行数', '删除行数'],
                        top: '10%'
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'value',
                        boundaryGap: [0, 0.01]
                    },
                    yAxis: {
                        type: 'category',
                        data: <%- typeof chartData.authorNames !== 'undefined' ? JSON.stringify(chartData.authorNames) : '[]' %>
                    },
                    series: [
                        {
                            name: '提交次数',
                            type: 'bar',
                            data: <%- typeof chartData.commitCounts !== 'undefined' ? JSON.stringify(chartData.commitCounts) : '[]' %>,
                            itemStyle: {
                                color: '#1976d2'
                            }
                        },
                        {
                            name: '插入行数',
                            type: 'bar',
                            data: <%- typeof chartData.totalInsertions !== 'undefined' ? JSON.stringify(chartData.totalInsertions) : '[]' %>,
                            itemStyle: {
                                color: '#4caf50'
                            }
                        },
                        {
                            name: '删除行数',
                            type: 'bar',
                            data: <%- typeof chartData.totalDeletions !== 'undefined' ? JSON.stringify(chartData.totalDeletions) : '[]' %>,
                            itemStyle: {
                                color: '#f44336'
                            }
                        }
                    ]
                };

                // 代码变更分布图
                const changesOption = {
                    title: {
                        text: '代码变更分布（新增 vs 删除）',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: {c} ({d}%)'
                    },
                    legend: {
                        orient: 'vertical',
                        left: 'left'
                    },
                    series: [
                        {
                            name: '变更类型',
                            type: 'pie',
                            radius: ['40%', '70%'],
                            avoidLabelOverlap: false,
                            itemStyle: {
                                borderRadius: 10,
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: {
                                show: true,
                                formatter: '{b}: {c}'
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: '18',
                                    fontWeight: 'bold'
                                }
                            },
                            data: [
                                { value: <%- typeof chartData.totalInsertionsSum !== 'undefined' ? chartData.totalInsertionsSum : 0 %>, name: '新增代码' },
                                { value: <%- typeof chartData.totalDeletionsSum !== 'undefined' ? chartData.totalDeletionsSum : 0 %>, name: '删除代码' }
                            ]
                        }
                    ]
                };

                // 提交趋势图
                const trendOption = {
                    title: {
                        text: '提交时间趋势',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'axis'
                    },
                    legend: {
                        data: ['提交次数', '代码净变化'],
                        top: '10%'
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        boundaryGap: false,
                        data: <%- typeof chartData.dates !== 'undefined' ? JSON.stringify(chartData.dates) : '[]' %>
                    },
                    yAxis: {
                        type: 'value'
                    },
                    series: [
                        {
                            name: '提交次数',
                            type: 'line',
                            data: <%- typeof chartData.commitTrends !== 'undefined' ? JSON.stringify(chartData.commitTrends) : '[]' %>,
                            itemStyle: {
                                color: '#1976d2'
                            },
                            areaStyle: {}
                        },
                        {
                            name: '代码净变化',
                            type: 'line',
                            data: <%- typeof chartData.codeChangeTrends !== 'undefined' ? JSON.stringify(chartData.codeChangeTrends) : '[]' %>,
                            itemStyle: {
                                color: '#ff9800'
                            },
                            areaStyle: {}
                        }
                    ]
                };

                // 渲染图表
                contributionChart.setOption(contributionOption);
                changesChart.setOption(changesOption);
                trendChart.setOption(trendOption);

                // 响应式调整
                window.addEventListener('resize', function() {
                    contributionChart.resize();
                    changesChart.resize();
                    trendChart.resize();
                });
            }
        });

        // 刷新数据函数
        function refreshData() {
            const repoPath = document.getElementById('repoPath').value;
            if (!repoPath) {
                alert('请输入仓库路径');
                return;
            }

            window.location.href = `/?repo=${encodeURIComponent(repoPath)}`;
        }
    </script>
</body>
</html>